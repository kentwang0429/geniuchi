<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Âü∫Á¥êÊ£ã (Geniuchi)</title>
    <style>
      :root {
        --bg: #fafafa;
        --card: #ffffff;
        --text: #111;
        --muted: #666;
        --border: #e6e6e6;
        --shadow: 0 8px 22px rgba(0, 0, 0, 0.08);
        --radius: 14px;
      }

      body {
        font-family: Arial, Helvetica, sans-serif;
        margin: 0;
        padding: 0;
        background: var(--bg);
        color: var(--text);
      }

      .page {
        max-width: 1080px;
        margin: 0 auto;
        padding: 14px 12px 18px;
      }

      .header {
        display: flex;
        align-items: baseline;
        justify-content: space-between;
        gap: 10px;
        margin-bottom: 10px;
      }
      .title {
        margin: 0;
        font-size: 20px;
      }
      .subtitle {
        margin: 0;
        color: var(--muted);
        font-size: 13px;
      }

      .card {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
      }

      .row {
        display: flex;
        gap: 12px;
        align-items: stretch;
      }
      .col {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .panel {
        padding: 12px;
      }

      .topbar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        padding: 10px 12px;
        position: sticky;
        top: 0;
        z-index: 5;
        background: rgba(250, 250, 250, 0.92);
        backdrop-filter: blur(8px);
      }

      input {
        width: 100%;
        box-sizing: border-box;
        padding: 10px 12px;
        border: 1px solid var(--border);
        border-radius: 10px;
        outline: none;
        font-size: 14px;
        background: #fff;
      }

      button {
        padding: 10px 12px;
        border: 1px solid var(--border);
        border-radius: 10px;
        background: #fff;
        cursor: pointer;
        font-size: 14px;
      }
      button:active {
        transform: translateY(1px);
      }
      button.primary {
        background: #111;
        color: #fff;
        border-color: #111;
      }
      button.success {
        background: #2e7d32;
        color: #fff;
        border-color: #2e7d32;
      }
      button.purple {
        background: #8e24aa;
        color: #fff;
        border-color: #8e24aa;
      }
      button.green {
        background: #4caf50;
        color: #fff;
        border-color: #4caf50;
      }
      button:disabled {
        opacity: 0.55;
        cursor: not-allowed;
      }

      .muted {
        color: var(--muted);
        font-size: 13px;
      }

      .actions {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }

      .kv {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
      }
      .pill {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 8px 10px;
        border: 1px solid var(--border);
        border-radius: 999px;
        background: #fff;
        font-size: 13px;
      }

      .player {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        padding: 8px 10px;
        border: 1px solid var(--border);
        border-radius: 12px;
        background: #fff;
      }
      .player-left {
        display: flex;
        align-items: center;
        gap: 10px;
        min-width: 0;
      }
      .dot {
        width: 14px;
        height: 14px;
        border-radius: 50%;
        flex: 0 0 auto;
        border: 1px solid rgba(0, 0, 0, 0.15);
      }
      .pname {
        font-weight: 700;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .pmeta {
        font-size: 12px;
        color: var(--muted);
      }
      .turnTag {
        font-size: 12px;
        padding: 4px 8px;
        border-radius: 999px;
        background: #111;
        color: #fff;
      }

      .color-palette {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }
      .color-choice {
        width: 30px;
        height: 30px;
        border-radius: 10px;
        cursor: pointer;
        border: 2px solid transparent;
        box-sizing: border-box;
      }
      .color-choice.selected {
        border-color: #111;
      }

      .roles-grid {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 10px;
      }
      .role-card {
        border: 1px solid var(--border);
        border-radius: 14px;
        background: #fff;
        padding: 10px;
        cursor: pointer;
      }
      .role-card.selected {
        outline: 3px solid rgba(0, 0, 0, 0.25);
      }
      .role-head {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
      }
      .role-name {
        font-weight: 800;
      }
      .role-skill {
        margin-top: 6px;
        font-size: 12px;
        color: var(--muted);
        line-height: 1.35;
      }

      .board-wrap {
        padding: 12px;
      }
      .board {
        border: 1px solid #333;
        background: #fff;
        display: inline-block;
        border-radius: 10px;
        overflow: hidden;
      }
      .board-grid {
        display: grid;
      }
      .cell {
        width: 28px;
        height: 28px;
        border: 1px solid #eee;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        position: relative;
      }
      .highlight-source {
        outline: 2px solid purple;
      }
      .highlight-target {
        outline: 2px dashed purple;
      }
      .highlight-gudo {
        outline: 2px solid green;
      }
      .highlight-gudo-target {
        outline: 2px dashed green;
      }
      .highlight-gudo-self {
        outline: 2px solid #4caf50;
      }

      .circle {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: currentColor;
      }
      .star::before {
        content: '‚òÖ';
        font-size: 28px;
        line-height: 1;
        color: currentColor;
      }
      .square {
        width: 20px;
        height: 20px;
        background: currentColor;
      }
      .triangle {
        width: 0;
        height: 0;
        border-left: 10px solid transparent;
        border-right: 10px solid transparent;
        border-bottom: 18px solid currentColor;
      }
      .logan {
        position: relative;
        width: 15px;
        height: 15px;
        border-radius: 50%;
        border: 2px solid currentColor;
        box-sizing: border-box;
      }
      .logan::before,
      .logan::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 28px;
        height: 3px;
        background: currentColor;
        transform-origin: center;
      }
      .logan::before {
        transform: translate(-50%, -50%) rotate(45deg);
      }
      .logan::after {
        transform: translate(-50%, -50%) rotate(-45deg);
      }
      .grayX {
        position: relative;
        width: 22px;
        height: 22px;
      }
      .grayX::before,
      .grayX::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 22px;
        height: 4px;
        background: currentColor;
        transform-origin: center;
      }
      .grayX::before {
        transform: translate(-50%, -50%) rotate(45deg);
      }
      .grayX::after {
        transform: translate(-50%, -50%) rotate(-45deg);
      }

      .info-panel {
        margin-top: 8px;
        padding: 10px;
        background: #f2f2f2;
        border-radius: 12px;
        font-size: 14px;
      }

      @media (max-width: 920px) {
        .row {
          flex-direction: column;
        }
        .roles-grid {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="page">
      <div class="header">
        <div>
          <h2 class="title">Âü∫Á¥êÊ£ã (Geniuchi)</h2>
          <p class="subtitle">Â§ö‰∫∫ÈÄ£Á∑öÔΩúLobby ÈÅ∏Ëßí ‚Üí ÈÄ≤ÂÖ•Ê£ãÁõ§</p>
        </div>
        <div class="pill">‰∫îËßíËâ≤ÁâàÊú¨</div>
      </div>
      <div id="app"></div>
    </div>

    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/socket.io/client-dist/socket.io.min.js"></script>

    <script>
      const e = React.createElement;

      const COLORS = [
        '#e53935',
        '#8e24aa',
        '#3949ab',
        '#1e88e5',
        '#00897b',
        '#fdd835',
      ];

      const ROLES = [
        { name: 'Âü∫Á¥ê', shape: 'circle' },
        { name: 'Â∑¥Áâπ', shape: 'star' },
        { name: 'ÂäõÂ∫´ÂßÜ', shape: 'square' },
        { name: 'ÁæÖÊ†π', shape: 'logan' },
        { name: 'Âè§Êùú', shape: 'triangle' },
      ];

      const ROLE_DESC = {
        0: 'ËÉΩÂäõÔºö‰∫§ÊèõÂêåÂàó/ÂêåË°å‰ªª‰∏ÄÊïµÊñπÊ£ãÔºàÊú¨ÂõûÂêà‰∏çËÉΩÂÖàËêΩÂ≠êÔºâ„ÄÇ',
        1: 'ÊØèÂõûÂêàÂèØ‰∏ã 2 Â≠êÔºõÂãùÂà©ÈúÄ 6 ÈÄ£Á∑ö„ÄÇ',
        2: 'ÂèØË¶ÜËìãÁ©∫Ê†ºÊàñ‰∏ÄËà¨Ê£ãÔºà‰∏çÂèØË¶ÜËìãÁÅ∞ÂèâÔºâ„ÄÇ',
        3: 'ÊØèÂõûÂêà 2 Âãï‰ΩúÔºöÂÖà‰∏ãÊ£ãÔºåÂÜçÊîæ 1 ÂÄãÁÅ∞ÂèâÔºàÂè™ËÉΩÊîæÁ©∫Ê†ºÔºâ„ÄÇ',
        4: 'ËÉΩÂäõÔºöÁßªÂãï„ÄåÂë®Âúç„Äç‰∏ÄÈ°ÜÊïµÊñπÊ£ãÂà∞Ë©≤Ê£ãÂë®ÂúçÁ©∫Ê†º„ÄÇ',
      };

      function connectSocket() {
        const params = new URLSearchParams(location.search);
        const serverUrl = params.get('server');
        if (serverUrl) {
          return io(serverUrl, {
            transports: ['websocket', 'polling'],
          });
        }
        return io();
      }

      function safeCopy(text) {
        try {
          if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(text);
            return;
          }
        } catch (e) {}
        prompt('Ë§áË£ΩÈÄôÊÆµÔºö', text);
      }

      function App() {
        const [socket, setSocket] = React.useState(null);
        const [room, setRoom] = React.useState(null);
        const [board, setBoard] = React.useState([]);
        const [name, setName] = React.useState('');
        const [selectedColor, setSelectedColor] = React.useState(null);
        const [selectedRole, setSelectedRole] = React.useState(null);
        const [highlightSources, setHighlightSources] = React.useState([]);
        const [highlightTargets, setHighlightTargets] = React.useState([]);
        const [highlightGudo, setHighlightGudo] = React.useState([]);
        const [highlightGudoTargets, setHighlightGudoTargets] = React.useState(
          []
        );
        const [highlightGudoSelf, setHighlightGudoSelf] = React.useState([]);
        const [ginyuMode, setGinyuMode] = React.useState(false);
        const [gudoMode, setGudoMode] = React.useState(false);
        const [turnInfo, setTurnInfo] = React.useState('');
        const roomRef = React.useRef(null);

        React.useEffect(() => {
          const s = connectSocket();
          setSocket(s);

          s.on('roomUpdated', (r) => {
            roomRef.current = r;
            setRoom(r);
            setBoard(r.board || []);
            updateTurnInfo(r);
          });

          s.on('placed', (payload) => {
            if (payload.board) setBoard(payload.board);

            if (roomRef.current) {
              roomRef.current = {
                ...roomRef.current,
                board: payload.board || roomRef.current.board,
                turnIndex:
                  typeof payload.turnIndex === 'number'
                    ? payload.turnIndex
                    : roomRef.current.turnIndex,
                roundCount:
                  typeof payload.roundCount === 'number'
                    ? payload.roundCount
                    : roomRef.current.roundCount,
                status: payload.status || roomRef.current.status,
              };
            }

            setRoom((prev) => {
              const base = prev || roomRef.current;
              if (!base) return base;
              return {
                ...base,
                board: payload.board || base.board,
                turnIndex:
                  typeof payload.turnIndex === 'number'
                    ? payload.turnIndex
                    : base.turnIndex,
                roundCount:
                  typeof payload.roundCount === 'number'
                    ? payload.roundCount
                    : base.roundCount,
                status: payload.status || base.status,
              };
            });

            if (payload.win) {
              const r = roomRef.current;
              const winner = r?.players?.[payload.win.winnerIndex];
              const winnerName = winner ? winner.name : payload.win.winnerId;
              alert(`üèÜ ÈÅäÊà≤ÁµêÊùüÔºÅÂãùÂà©ËÄÖÔºö${winnerName}`);
            }

            setHighlightSources([]);
            setHighlightTargets([]);
            setHighlightGudo([]);
            setHighlightGudoTargets([]);
            setHighlightGudoSelf([]);
            setGinyuMode(false);
            setGudoMode(false);
            if (roomRef.current) {
              roomRef.current.gudoClientStep = 'idle';
            }

            updateTurnInfo(roomRef.current);
          });

          s.on('gudoCancelled', () => {
            setHighlightGudo([]);
            setHighlightGudoTargets([]);
            setHighlightGudoSelf([]);
            setGudoMode(false);
            if (roomRef.current) {
              roomRef.current.gudoClientStep = 'idle';
            }
          });

          // Ëã•ÂæåÁ´ØÊúâÈÄÅ ginyuCancelledÔºåÂâçÁ´ØÊúÉÊ∏ÖÈô§ÔºàÊ≤íÊúâ‰πü‰∏çÂΩ±ÈüøÔºâ
          s.on('ginyuCancelled', (payload) => {
            setHighlightSources([]);
            setHighlightTargets([]);
            setGinyuMode(false);
            if (payload?.message) alert(payload.message);
          });

          return () => {
            try {
              s.disconnect();
            } catch (e) {}
          };
        }, []);

        function updateTurnInfo(r) {
          if (!r || !r.players || r.status !== 'PLAYING') {
            setTurnInfo('');
            return;
          }
          const turnPlayer = r.players[r.turnIndex];
          setTurnInfo(
            `ÂõûÂêàÔºö${r.roundCount || 1}ÔΩúËº™Âà∞Ôºö${turnPlayer?.name || 'N/A'}`
          );
        }

        function createRoom() {
          if (!socket) return;
          socket.emit(
            'createRoom',
            { maxPlayers: 4, name: name.trim() },
            (res) => {
              if (res.ok) setRoom(res.room);
            }
          );
        }

        function joinRoom() {
          if (!socket) return;
          const id = prompt('Ëº∏ÂÖ•ÊàøÈñìID');
          if (!id) return;
          socket.emit('joinRoom', { roomId: id, name: name.trim() }, (res) => {
            if (res.ok) setRoom(res.room);
            else alert(res.message || 'Âä†ÂÖ•Â§±Êïó');
          });
        }

        function pickColor(i) {
          if (!room || !socket) return;
          setSelectedColor(i);
          socket.emit(
            'pickColor',
            { roomId: room.id, colorIndex: i },
            (res) => {
              if (res.ok) setRoom(res.room);
            }
          );
        }

        function pickRole(i) {
          if (!room || !socket) return;
          setSelectedRole(i);
          socket.emit('pickRole', { roomId: room.id, roleIndex: i }, (res) => {
            if (res.ok) setRoom(res.room);
          });
        }

        function readyUp() {
          if (!room || !socket) return;
          if (selectedColor === null || selectedRole === null)
            return alert('Ë´ãÂÖàÈÅ∏ÊìáÈ°èËâ≤ËàáËßíËâ≤');
          socket.emit('readyUp', { roomId: room.id }, (res) => {
            if (!res.ok && res.message) alert(res.message);
          });
        }

        function startGame() {
          if (!room || !socket) return;
          socket.emit('startGame', { roomId: room.id });
        }

        function place(x, y) {
          if (!room || room.status !== 'PLAYING' || !socket) return;

          // Âü∫Á¥êËÉΩÂäõ
          if (ginyuMode) {
            const inSources = highlightSources.some(
              (p) => p.x === x && p.y === y
            );
            const inTargets = highlightTargets.some(
              (p) => p.x === x && p.y === y
            );

            if (highlightSources.length && !highlightTargets.length) {
              if (!inSources) {
                setHighlightSources([]);
                setHighlightTargets([]);
                setGinyuMode(false);
                return;
              }
              socket.emit(
                'ginyuSelectSource',
                { roomId: room.id, x, y },
                (res) => {
                  if (res.ok) setHighlightTargets(res.targets);
                  else {
                    alert(res.message);
                    setHighlightSources([]);
                    setHighlightTargets([]);
                    setGinyuMode(false);
                  }
                }
              );
              return;
            }

            if (highlightTargets.length) {
              if (!inTargets) {
                setHighlightSources([]);
                setHighlightTargets([]);
                setGinyuMode(false);
                return;
              }
              socket.emit(
                'ginyuSelectTarget',
                { roomId: room.id, x, y },
                (res) => {
                  if (!res.ok) {
                    alert(res.message);
                    setHighlightSources([]);
                    setHighlightTargets([]);
                    setGinyuMode(false);
                  }
                }
              );
              return;
            }

            setHighlightSources([]);
            setHighlightTargets([]);
            setGinyuMode(false);
            return;
          }

          // Âè§ÊùúËÉΩÂäõ
          if (gudoMode) {
            const localRoom = roomRef.current || room;

            if (
              !localRoom.gudoClientStep ||
              localRoom.gudoClientStep === 'idle'
            ) {
              socket.emit(
                'gudoSelectSource',
                { roomId: localRoom.id, x, y },
                (res) => {
                  if (res.ok) {
                    setHighlightGudo(res.highlights || []);
                    localRoom.gudoClientStep = 'selectTarget';
                  } else {
                    alert(res.message);
                    setGudoMode(false);
                    setHighlightGudo([]);
                    setHighlightGudoTargets([]);
                    setHighlightGudoSelf([]);
                    localRoom.gudoClientStep = 'idle';
                  }
                }
              );
              return;
            }

            if (localRoom.gudoClientStep === 'selectTarget') {
              socket.emit(
                'gudoSelectTarget',
                { roomId: localRoom.id, x, y },
                (res) => {
                  if (res.ok) {
                    setHighlightGudoTargets(res.emptyAround || []);
                    localRoom.gudoClientStep = 'selectMove';
                  } else {
                    alert(res.message);
                    setGudoMode(false);
                    setHighlightGudo([]);
                    setHighlightGudoTargets([]);
                    setHighlightGudoSelf([]);
                    localRoom.gudoClientStep = 'idle';
                  }
                }
              );
              return;
            }

            if (localRoom.gudoClientStep === 'selectMove') {
              socket.emit(
                'gudoMovePiece',
                { roomId: localRoom.id, x, y },
                (res) => {
                  if (!res.ok) alert(res.message);
                }
              );
              return;
            }
          }

          // Ê≠£Â∏∏‰∏ãÊ£ã
          socket.emit('place', { roomId: room.id, x, y }, (res) => {
            if (!res.ok && res.message) alert(res.message);
          });
        }

        function activateGinyu() {
          if (!room || !socket) return;
          socket.emit('ginyuAbilityStart', { roomId: room.id }, (res) => {
            if (res.ok) {
              setGinyuMode(true);
              setHighlightSources(res.sources);
            } else alert(res.message);
          });
        }

        function activateGudo() {
          if (!room || !socket) return;
          socket.emit('gudoAbilityStart', { roomId: room.id }, (res) => {
            if (res.ok) {
              setGudoMode(true);
              setHighlightGudo([]);
              setHighlightGudoTargets([]);
              setHighlightGudoSelf(res.sources || []);
              if (roomRef.current) roomRef.current.gudoClientStep = 'idle';
            } else alert(res.message);
          });
        }

        const me = room?.players?.find((p) => p.id === socket?.id);
        const isMyTurn =
          room &&
          me &&
          room.turnIndex !== undefined &&
          room.players[room.turnIndex]?.id === me.id;

        if (!room) {
          return e(StartScreen, {
            name,
            setName,
            createRoom,
            joinRoom,
          });
        }

        if (room.status === 'LOBBY') {
          return e(LobbyScreen, {
            room,
            me,
            selectedColor,
            selectedRole,
            pickColor,
            pickRole,
            readyUp,
            startGame,
            socket,
          });
        }

        return e(GameScreen, {
          room,
          board,
          onPlace: place,
          isMyTurn,
          me,
          turnInfo,
          activateGinyu,
          activateGudo,
          highlightSources,
          highlightTargets,
          highlightGudo,
          highlightGudoTargets,
          highlightGudoSelf,
        });
      }

      function StartScreen({ name, setName, createRoom, joinRoom }) {
        return e(
          'div',
          { className: 'card panel' },
          e('div', { className: 'muted' }, 'Á¨¨‰∏ÄÊ≠•ÔºöËº∏ÂÖ•ÂêçÂ≠ó ‚Üí Âª∫ÊàøÊàñÂä†ÂÖ•ÊàøÈñì'),
          e('div', { style: { height: 10 } }),
          e('input', {
            value: name,
            onChange: (ev) => setName(ev.target.value),
            placeholder: 'Ëº∏ÂÖ•ÂêçÁ®±ÔºàÂª∫Ë≠∞ 2~10 Â≠óÔºâ',
          }),
          e('div', { style: { height: 10 } }),
          e(
            'div',
            { className: 'actions' },
            e(
              'button',
              { className: 'primary', onClick: createRoom },
              'Create Room'
            ),
            e('button', { onClick: joinRoom }, 'Join Room')
          )
        );
      }

      function LobbyScreen({
        room,
        me,
        selectedColor,
        selectedRole,
        pickColor,
        pickRole,
        readyUp,
        startGame,
        socket,
      }) {
        const isHost = room?.hostId === socket?.id;
        const allReady =
          room?.players?.length && room.players.every((p) => p.ready);

        return e(
          'div',
          { className: 'row' },
          e(
            'div',
            { className: 'col', style: { flex: '0 0 360px' } },
            e(
              'div',
              { className: 'card panel' },
              e(
                'div',
                { className: 'kv' },
                e(
                  'div',
                  null,
                  e('div', { style: { fontWeight: 800 } }, 'Lobby'),
                  e('div', { className: 'muted' }, 'ÊàøÈñìËàáÈÅ∏Ëßí')
                ),
                e(
                  'button',
                  {
                    onClick: () => safeCopy(room.id),
                  },
                  'Copy Room ID'
                )
              ),
              e('div', { style: { height: 8 } }),
              e(
                'div',
                { className: 'pill' },
                'Room IDÔºö',
                e('b', null, room.id)
              )
            ),

            e(
              'div',
              { className: 'card panel' },
              e(
                'div',
                { style: { fontWeight: 800, marginBottom: 8 } },
                'Áé©ÂÆ∂ÂàóË°®'
              ),
              room.players?.map((p, idx) =>
                e(
                  'div',
                  { key: p.id, className: 'player' },
                  e(
                    'div',
                    { className: 'player-left' },
                    e('div', {
                      className: 'dot',
                      style: { background: COLORS[p.colorIndex ?? 0] },
                    }),
                    e(
                      'div',
                      { style: { minWidth: 0 } },
                      e(
                        'div',
                        { className: 'pname' },
                        `${p.name || 'Player'}${
                          me?.id === p.id ? 'Ôºà‰Ω†Ôºâ' : ''
                        }`
                      ),
                      e(
                        'div',
                        { className: 'pmeta' },
                        `Áé©ÂÆ∂IDÔºö${idx + 1}ÔΩúËßíËâ≤Ôºö${
                          ROLES[p.roleIndex ?? 0]?.name || 'Êú™ÈÅ∏'
                        }`
                      )
                    )
                  ),
                  p.ready
                    ? e('div', null, '‚úÖ')
                    : e('div', { className: 'muted' }, 'Êú™Ê∫ñÂÇô')
                )
              )
            )
          ),

          e(
            'div',
            { className: 'col', style: { flex: '1 1 auto' } },
            e(
              'div',
              { className: 'card panel' },
              e(
                'div',
                { style: { fontWeight: 800, marginBottom: 8 } },
                'ÈÅ∏ÊìáÈ°èËâ≤'
              ),
              e(
                'div',
                { className: 'color-palette' },
                COLORS.map((c, i) =>
                  e('div', {
                    key: i,
                    className:
                      'color-choice' + (selectedColor === i ? ' selected' : ''),
                    style: { background: c },
                    onClick: () => pickColor(i),
                  })
                )
              ),
              e('div', { style: { height: 10 } }),
              e(
                'div',
                { style: { fontWeight: 800, marginBottom: 8 } },
                'ÈÅ∏ÊìáËßíËâ≤ÔºàÂê´ÊäÄËÉΩ‰ªãÁ¥πÔºâ'
              ),
              e(
                'div',
                { className: 'roles-grid' },
                ROLES.map((r, i) =>
                  e(
                    'div',
                    {
                      key: i,
                      className:
                        'role-card' + (selectedRole === i ? ' selected' : ''),
                      onClick: () => pickRole(i),
                    },
                    e(
                      'div',
                      { className: 'role-head' },
                      e(
                        'div',
                        null,
                        e('div', { className: 'role-name' }, r.name)
                        // ‚úÖ Â∑≤Âà™Èô§ roleIndex=... È°ØÁ§∫
                      ),
                      e('div', { className: r.shape, style: { color: '#333' } })
                    ),
                    e('div', { className: 'role-skill' }, ROLE_DESC[i] || '')
                  )
                )
              ),
              e('div', { style: { height: 12 } }),
              e(
                'div',
                { className: 'actions' },
                e(
                  'button',
                  { className: 'success', onClick: readyUp },
                  'Ê∫ñÂÇôÂÆåÊàê'
                ),
                isHost && allReady
                  ? e(
                      'button',
                      { className: 'primary', onClick: startGame },
                      'Start Game'
                    )
                  : e(
                      'button',
                      { disabled: true },
                      isHost ? 'Á≠âÂæÖÊâÄÊúâ‰∫∫Ê∫ñÂÇô' : 'Á≠âÂæÖÊàø‰∏ªÈñãÂßã'
                    )
              )
            ),

            e(
              'div',
              { className: 'card panel' },
              e('div', { style: { fontWeight: 800 } }, '‰Ω†ÁöÑË®≠ÂÆö'),
              e(
                'div',
                { className: 'muted', style: { marginTop: 6 } },
                `‰Ω†ÊòØÔºö${me?.name || 'N/A'}ÔΩúÈ°èËâ≤Ôºö$${
                  me?.colorIndex === null || me?.colorIndex === undefined
                    ? 'Êú™ÈÅ∏'
                    : me.colorIndex
                }ÔΩúËßíËâ≤Ôºö$${
                  me?.roleIndex === null || me?.roleIndex === undefined
                    ? 'Êú™ÈÅ∏'
                    : ROLES[me.roleIndex]?.name
                }`
              )
            )
          )
        );
      }

      function GameScreen({
        room,
        board,
        onPlace,
        isMyTurn,
        me,
        turnInfo,
        activateGinyu,
        activateGudo,
        highlightSources,
        highlightTargets,
        highlightGudo,
        highlightGudoTargets,
        highlightGudoSelf,
      }) {
        const current = room?.players?.[room?.turnIndex];

        return e(
          'div',
          { className: 'col' },
          e(
            'div',
            { className: 'topbar' },
            e(
              'div',
              { className: 'pill' },
              'RoomÔºö',
              e('b', null, room.id),
              e(
                'button',
                {
                  style: { padding: '6px 10px' },
                  onClick: () => safeCopy(room.id),
                },
                'Copy'
              )
            ),
            e('div', { className: 'pill' }, turnInfo || 'ÈÄ≤Ë°å‰∏≠‚Ä¶')
          ),

          e(
            'div',
            { className: 'row' },
            e(
              'div',
              { className: 'card board-wrap', style: { flex: '1 1 auto' } },
              board.length > 0
                ? e(Board, {
                    board,
                    onPlace,
                    room,
                    highlightSources,
                    highlightTargets,
                    highlightGudo,
                    highlightGudoTargets,
                    highlightGudoSelf,
                  })
                : e('div', { className: 'muted' }, 'Â∞öÊú™ÈñãÂßãÈÅäÊà≤')
            ),

            e(
              'div',
              { className: 'col', style: { flex: '0 0 360px' } },
              e(
                'div',
                { className: 'card panel' },
                e(
                  'div',
                  { className: 'kv' },
                  e(
                    'div',
                    null,
                    e('div', { style: { fontWeight: 800 } }, 'ÊàøÈñìË≥áË®ä'),
                    e(
                      'div',
                      { className: 'muted' },
                      `ÁõÆÊ®ôÈÄ£Á∑öÔºö${room.targetN}`
                    )
                  ),
                  current
                    ? e(
                        'div',
                        { className: 'turnTag' },
                        `Ëº™Âà∞Ôºö${current.name || 'N/A'}`
                      )
                    : null
                )
              ),

              e(
                'div',
                { className: 'card panel' },
                e(
                  'div',
                  { style: { fontWeight: 800, marginBottom: 8 } },
                  'Áé©ÂÆ∂ÂàóË°®'
                ),
                room.players?.map((p, idx) => {
                  const isTurn = current?.id === p.id;
                  return e(
                    'div',
                    {
                      key: p.id,
                      className: 'player',
                      style: isTurn ? { borderColor: '#111' } : null,
                    },
                    e(
                      'div',
                      { className: 'player-left' },
                      e('div', {
                        className: 'dot',
                        style: { background: COLORS[p.colorIndex ?? 0] },
                      }),
                      e(
                        'div',
                        { style: { minWidth: 0 } },
                        e(
                          'div',
                          { className: 'pname' },
                          `${p.name || 'Player'}${
                            me?.id === p.id ? 'Ôºà‰Ω†Ôºâ' : ''
                          }`
                        ),
                        e(
                          'div',
                          { className: 'pmeta' },
                          `Áé©ÂÆ∂IDÔºö${idx + 1}ÔΩúËßíËâ≤Ôºö${
                            ROLES[p.roleIndex ?? 0]?.name || 'N/A'
                          }`
                        )
                      )
                    ),
                    isTurn ? e('div', null, 'üéØ') : null
                  );
                })
              ),

              e(
                'div',
                { className: 'card panel' },
                e('div', { style: { fontWeight: 800 } }, 'ËÉΩÂäõ'),
                e(
                  'div',
                  { className: 'muted', style: { marginTop: 6 } },
                  `‰Ω†Ôºö${me?.name || 'N/A'}ÔΩúËßíËâ≤Ôºö$${
                    me?.roleIndex === null || me?.roleIndex === undefined
                      ? 'Êú™ÈÅ∏'
                      : ROLES[me.roleIndex]?.name
                  }`
                ),
                e('div', { style: { height: 10 } }),
                e(
                  'div',
                  { className: 'actions' },
                  e(
                    'button',
                    {
                      className: 'purple',
                      disabled: !(isMyTurn && me?.roleIndex === 0),
                      onClick: activateGinyu,
                    },
                    'ÁôºÂãïÂü∫Á¥êËÉΩÂäõ'
                  ),
                  e(
                    'button',
                    {
                      className: 'green',
                      disabled: !(isMyTurn && me?.roleIndex === 4),
                      onClick: activateGudo,
                    },
                    'ÁôºÂãïÂè§ÊùúËÉΩÂäõ'
                  )
                ),
                e(
                  'div',
                  { className: 'info-panel' },
                  isMyTurn
                    ? '‚úÖ Ëº™Âà∞‰Ω†‰∫ÜÔºåË´ã‰∏ãÊ£ãÊàñ‰ΩøÁî®ËÉΩÂäõ„ÄÇ'
                    : '‚è≥ Á≠âÂæÖÂÖ∂‰ªñÁé©ÂÆ∂Êìç‰Ωú‚Ä¶'
                )
              )
            )
          )
        );
      }

      function Board({
        board,
        onPlace,
        room,
        highlightSources,
        highlightTargets,
        highlightGudo,
        highlightGudoTargets,
        highlightGudoSelf,
      }) {
        const size = board.length;
        const cells = [];
        for (let y = 0; y < size; y++) {
          for (let x = 0; x < size; x++) {
            const v = board[y][x];
            const player =
              v > 0 ? room.players[(v - 1) % room.players.length] : null;
            const color = player ? COLORS[player.colorIndex || 0] : '#000';

            let className = 'cell';
            if (highlightSources.some((p) => p.x === x && p.y === y))
              className += ' highlight-source';
            if (highlightTargets.some((p) => p.x === x && p.y === y))
              className += ' highlight-target';
            if (highlightGudo.some((p) => p.x === x && p.y === y))
              className += ' highlight-gudo';
            if (highlightGudoTargets.some((p) => p.x === x && p.y === y))
              className += ' highlight-gudo-target';
            if (highlightGudoSelf.some((p) => p.x === x && p.y === y))
              className += ' highlight-gudo-self';

            let inner = null;
            if (v > 0) {
              const role = ROLES[player.roleIndex] || ROLES[0];
              inner = e('div', { className: role.shape, style: { color } });
            } else if (v < 0) {
              const ownerIndex = Math.abs(v) - 1;
              const owner = room.players[ownerIndex];
              const baseColor = COLORS[owner.colorIndex || 0];
              const darker = `rgb(${
                parseInt(baseColor.slice(1, 3), 16) * 0.6
              }, ${parseInt(baseColor.slice(3, 5), 16) * 0.6}, ${
                parseInt(baseColor.slice(5, 7), 16) * 0.6
              })`;
              inner = e('div', {
                className: 'grayX',
                style: { color: darker },
              });
            }

            cells.push(
              e(
                'div',
                { key: `${x},${y}`, className, onClick: () => onPlace(x, y) },
                inner
              )
            );
          }
        }

        return e(
          'div',
          { className: 'board' },
          e(
            'div',
            {
              className: 'board-grid',
              style: { gridTemplateColumns: `repeat(${size}, 28px)` },
            },
            cells
          )
        );
      }

      ReactDOM.createRoot(document.getElementById('app')).render(e(App));
    </script>
  </body>
</html>
